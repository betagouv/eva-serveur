# frozen_string_literal: true

active_admin_form_for [:admin, resource] do |f|
  f.semantic_errors
  f.inputs do
    f.input :libelle
    f.input :categorie, as: :select
    f.input :nom_technique
    f.input :description
    f.input :illustration, as: :file,
                           input_html: { accept: Question::ILLUSTRATION_CONTENT_TYPES.join(',') },
                           hint: t('.illustration.hint')

    if f.object.illustration.attached?
      f.input :supprimer_illustration, as: :boolean,
                                       label: t('.label.supprimer_illustration'),
                                       hint: image_tag(cdn_for(f.object.illustration))
    end
  end

  f.inputs do
    if f.object.new_record?
      f.object.transcriptions.build

      f.has_many :transcriptions, allow_destroy: false, new_record: false, heading: false do |t|
        t.input :id, as: :hidden
        t.input :ecrit, label: t('.label.intitule')
        t.input :audio, as: :file, label: t('.label.intitule_audio'),
                        input_html: { accept: 'audio/mpeg, audio/mp4' }
      end
      f.has_many :transcriptions, allow_destroy: false, new_record: false, heading: false do |t|
        t.input :id, as: :hidden
        t.input :ecrit, label: t('.label.modalite_reponse')
        t.input :audio, as: :file, label: t('.label.modalite_reponse_audio'),
                        input_html: { accept: 'audio/mpeg, audio/mp4' }
        t.input :categorie, as: :hidden, input_html: { value: :modalite_reponse }
      end
    else
      if f.object.transcription_pour(:intitule).nil?
        f.object.transcriptions.build(categorie: :intitule)
      end
      f.has_many :transcriptions, allow_destroy: false, new_record: false, heading: false do |t|
        if t.object.intitule?
          t.input :id, as: :hidden
          t.input :ecrit, label: t('.label.intitule'), input_html: { rows: 4 }
          t.input :audio, as: :file, label: 'Intitul√© audio',
                          input_html: { accept: 'audio/mpeg, audio/mp4' }
          t.input :categorie, as: :hidden, input_html: { value: :intitule }
        end
      end
      if f.object.transcription_pour(:intitule).audio.attached?
        f.input :supprimer_audio_intitule, as: :boolean,
                                           label: t('.label.supprimer_audio_intitule'),
                                           hint: tag_audio(f.object.transcription_pour(:intitule))
      end
      if f.object.transcription_pour(:modalite_reponse).nil?
        f.object.transcriptions.build(categorie: :modalite_reponse)
      end
      f.has_many :transcriptions, allow_destroy: false, new_record: false, heading: false do |t|
        if t.object.modalite_reponse?
          t.input :id, as: :hidden
          t.input :ecrit, label: t('.label.modalite_reponse'), input_html: { rows: 4 }
          t.input :audio, as: :file, label: t('.label.modalite_reponse_audio'),
                          input_html: { accept: 'audio/mpeg, audio/mp4' }
          t.input :categorie, as: :hidden, input_html: { value: :modalite_reponse }
        end
      end
      if f.object.transcription_pour(:modalite_reponse)&.audio&.attached?
        f.input :supprimer_audio_modalite_reponse,
                as: :boolean,
                label: t('.label.supprimer_audio_modalite'),
                hint: tag_audio(f.object.transcription_pour(:modalite_reponse))
      end
    end
    f.input :suffix_reponse
    f.input :reponse_placeholder
    f.input :type_saisie
    f.has_many :choix, allow_destroy: false, new_record: t('.ajout_reponse'), heading: false,
                       class: 'has_one' do |c|
      c.input :id, as: :hidden
      c.input :intitule, label: t('.label.reponse')
      c.input :nom_technique, label: t('.label.reponse_nom_technique')
      c.input :type_choix, as: :hidden, input_html: { value: :bon }
    end
  end
  f.actions do
    f.action :submit
    annulation_formulaire(f)
  end
end
