# frozen_string_literal: true

div class: 'admin_restitution_globale' do
  div class: 'en-tete' do
    div class: 'eva-logo' do
      span wicked_pdf_image_tag 'eva-logo.svg' if pdf
    end
    div class: 'identite' do
      div class: 'date-restitution' do
        l restitution_globale.date, format: :restitution
      end
      div class: 'nom-evalue' do
        strong restitution_globale.utilisateur
      end
    end
  end

  h2 class: 'text-center titre-classement-competences' do
    span t('.competences_fortes_titre')
    br
    span class: 'legende-titre' do
      t('.legende_titre')
    end
  end

  div class: 'row saut-de-page' do
    rang_competence = 0
    valeur_competence_precedente = -1
    restitution_globale.niveaux_competences.each do |niveau_competence|
      competence = niveau_competence.keys.first
      if valeur_competence_precedente != niveau_competence.values.first
        rang_competence += 1
        valeur_competence_precedente = niveau_competence.values.first
      end
      ul class: 'competences-identifiees col-12' do
        div class: 'identification-competence col-6' do
          div class: "jauge jauge-#{rang_competence}"
          if pdf
            span wicked_pdf_image_tag competence.to_s
          else
            span image_tag competence
          end
          span class: 'nom-competence' do
            t("#{competence}.nom", scope: 'admin.evaluations.restitution_competence')
          end
        end

        div class: 'description-competence col-6' do
          div t("#{competence}.description",
                scope: 'admin.evaluations.restitution_competence')
          url_competence = "#{URL_COMPETENCES_SITE_VITRINE}#{competence}/"
          a href: url_competence, target: '_blank' do
            if pdf
              t('.url_competence') + ' ' + url_competence
            else
              div t('.url_competence')
              div url_competence
            end
          end
        end
      end
    end
  end

  if can?(:manage, Compte)
    panel 'Scores non normalis√©s' do
      div class: 'scores' do
        attributes_table_for restitution_globale do
          restitution_globale.scores.each do |nom_metrique, valeur|
            row(nom_metrique) { valeur&.round(2) }
          end
        end
      end
    end
  end

  restitution_globale.restitutions.each do |restitution|
    situation = restitution.situation
    next if situation.nom_technique == Restitution::Bienvenue::NOM_TECHNIQUE

    panel t('.situation', situation: situation.libelle) do
      begin
        render situation.nom_technique, restitution: restitution
      rescue ActionView::MissingTemplate
        nil
      end
      render 'restitution_competences', restitution: restitution
    end
  end
end
