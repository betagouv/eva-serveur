# frozen_string_literal: true

div class: 'admin_restitution_globale' do
  div class: 'en-tete' do
    div class: 'eva-logo' do
      span wicked_pdf_image_tag 'eva-logo.svg' if pdf
    end
    div class: 'identite' do
      div class: 'date-restitution' do
        l restitution_globale.date, format: :restitution
      end
      div class: 'nom-evalue' do
        strong restitution_globale.utilisateur
      end
    end
  end

  h2 class: 'text-center titre-classement-competences' do
    span t('.competences_fortes_titre')
    br
    span class: 'legende-titre' do
      t('.legende_titre')
    end
  end

  div class: 'row saut-de-page' do
    restitution_globale.niveaux_competences.each do |niveau_competence|
      competence = niveau_competence.keys.first
      ul class: 'competences-identifiees col-12' do
        div class: 'col-6' do
          if pdf
            span wicked_pdf_image_tag competence
          else
            span image_tag competence
          end
          span class: 'nom-competence' do
            t("#{competence}.nom", scope: 'admin.evaluations.restitution_competence')
          end
        end

        div class: 'description-competence col-6' do
          div t("#{competence}.detail",
                scope: 'admin.evaluations.restitution_competence')
          url_competence = "#{URL_COMPETENCES_SITE_VITRINE}#{competence}/"
          a href: url_competence, target: '_blank' do
            url_competence
          end
        end
      end
    end
  end

  h2 class: 'text-center' do
    span class: 'btn btn-info btn-lg' do
      t('.efficience_globale', efficience: formate_efficience(restitution_globale.efficience))
    end
  end

  panel 'Efficiences par situations' do
    div class: :row do
      restitution_globale.restitutions.each do |restitution|
        next if restitution.efficience.nil?

        situation = restitution.situation
        div class: "#{rapport_colonne_class} #{situation.nom_technique}" do
          div t('.situation', situation: situation.libelle)
          div class: :progress do
            efficience = progression_efficience(restitution.efficience)
            div class: 'progress-bar', role: 'progressbar', style: "width: #{efficience}%",
                'aria-valuemin': 0, 'aria-valuemax': 100, 'aria-valuenow': efficience do
              formate_efficience(restitution.efficience)
            end
          end
        end
      end
      nil
    end
  end

  restitution_globale.restitutions.each do |restitution|
    situation = restitution.situation
    panel t('.situation', situation: situation.libelle) do
      render situation.nom_technique, restitution: restitution
      render 'restitution_competences', restitution: restitution
    end
  end
end
