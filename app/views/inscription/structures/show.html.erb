<% content_for :classes_conteneur do "conteneur-elargi conteneur-invisible" end %>

<% persisted = @structure.persisted? %>

<% if persisted %>
  <% content_for :title, t(".rejoindre_structure.titre") %>
  <% content_for :titre, t(".rejoindre_structure.titre") %>
  <% content_for :sous_titre, t(".rejoindre_structure.sous_titre") %>
<% else %>
  <% content_for :title, t(".creer.titre") %>
  <% content_for :titre, t(".creer.titre") %>
<% end %>

<div class="page-inscription-structure">
  <% if persisted %>
    <%# Structure existante : rejoindre %>
    <%= render TexteIntroComponent.new(titre: t(".titre_intro_presente"), texte: t(".sous_titre_intro_presente")) %>
  <% else %>
    <%= render TexteIntroComponent.new(titre: t(".titre_intro_non_presente"), texte: t(".sous_titre_intro_non_presente")) %>
    <%# Nouvelle structure : créer %>
    <%= dsfr_alert(type: :info, title: t(".alert_creation.titre")) do %>
      <%= t(".alert_creation.message") %>
    <% end %>
  <% end %>

  <% if persisted %>
    <%= semantic_form_for @compte, url: inscription_structure_path do |form| %>
      <%= form.semantic_errors *champs_non_affiches(form.object.errors.messages.keys, []) %>

      <%= form.inputs do %>
        <%= render CarteV2Component.new(titre: t(".titre_carte")) do %>
          <div class="structure-content-wrapper">
            <div class="structure-info-card">
              <div class="structure-info-card__info">
                <span class="structure-info-card__label">• Numéro SIRET :</span> <span class="structure-info-card__value"><%= @structure.siret %></span>
              </div>
              <div class="structure-info-card__info">
                <span class="structure-info-card__label">• Dénomination :</span> <span class="structure-info-card__value"><%= @structure.nom %></span>
              </div>
              <div class="structure-info-card__info">
                <span class="structure-info-card__label">• Adresse :</span> <span class="structure-info-card__value"><%= @structure.adresse %></span>
              </div>
            </div>

            <%= form.input :structure_confirmee, as: :boolean, label: t(".confirme_structure"), required: false %>

            <p class="structure-confirmation-mention">
              <%= t(".mention_acces") %>
            </p>

            <div class="informations-compte-actions">
              <%= form.button t(".ce_nest_pas_ma_structure"), type: :submit, name: "commit", value: "recherche", class: "bouton-tertiaire grand-bouton", formaction: inscription_structure_path(action_type: "recherche") %>
              <%= form.button t(".rejoindre"), type: :submit, name: "commit", value: "rejoindre", class: "bouton grand-bouton", id: "rejoindre-structure-btn", disabled: true %>
            </div>
          </div>
        <% end %>
      <% end %>
    <% end %>
  <% else %>
    <%= semantic_form_for @structure, url: inscription_structure_path, method: :patch do |form| %>
      <%= form.semantic_errors *champs_non_affiches(form.object.errors.messages.keys, [ :raison_sociale ]) %>
      <%= form.hidden_field :action_type, value: "creer" %>
      
      <%= form.inputs do %>
        <%= render CarteV2Component.new do %>
          <div class="fr-grid-row fr-grid-row--gutters">
            <div class="fr-col-12 fr-col-md-4 fr-mb-4v">
              <div class="fr-text--sm fr-text--bold fr-mb-2v">SIRET</div>
              <div class="fr-mb-0 fr-text--sm fr-mt-1v"><%= @structure.siret %></div>
            </div>
            <div class="fr-col-12 fr-col-md-4 fr-mb-4v">
              <div class="fr-text--sm fr-text--bold fr-mb-2v">Raison sociale</div>
              <div class="fr-mb-0 fr-text--sm fr-mt-1v"><%= @structure.raison_sociale %></div>
            </div>
            <div class="fr-col-12 fr-col-md-4 fr-mb-4v">
              <div class="fr-text--sm fr-text--bold fr-mb-2v">Adresse</div>
              <div class="fr-mb-0 fr-text--sm fr-mt-1v"><%= @structure.adresse %></div>
            </div>
          </div>
        <% end %>

        <%= render CarteV2Component.new do %>
          <div class="fr-grid-row fr-grid-row--gutters fr-mb-4v">
            <div class="fr-col-12">
              <%= render InputComponent.new(
                id: "structure_nom",
                label: t(".nom_structure_label"),
                form: form,
                method: :nom,
                type: "text"
              ) %>
            </div>
            <div class="fr-col-12">
              <%= render InputComponent.new(
                id: "structure_type_structure",
                label: t(".type_structure_label"),
                form: form,
                method: :type_structure,
                as: :select,
                collection: collection_types_structures,
                include_blank: t(".choisir_type"),
                required: true
              ) %>
            </div>
          </div>

          <p class="structure-confirmation-mention">
            <%= t(".mention_creation") %>
          </p>

        <% end %>

        <div class="fr-grid-row fr-grid-row--gutters fr-grid-row--middle">
          <div class="fr-col-12 fr-col-md-6">
            <%= render BoutonComponent.new(inscription_structure_path(action_type: "recherche"), tag: :button, type: :secondary, name: "commit", value: "recherche", method: :patch) do %>
              <%= t(".ce_nest_pas_ma_structure") %>
            <% end %>
          </div>
          <div class="fr-col-12 fr-col-md-6 inscription-structure__actions-droite">
            <%= form.submit t(".creer_structure"), class: "fr-btn fr-btn--primary" %>
          </div>
        </div>
      <% end %>
    <% end %>
  <% end %>
</div>

<% if persisted %>
<script>
  function activation_bouton_rejoindre(structure_confirmee) {
    let bouton_rejoindre = document.getElementById('rejoindre-structure-btn');
    if (structure_confirmee) {
      bouton_rejoindre.classList.remove('disabled');
      bouton_rejoindre.removeAttribute('disabled');
    } else {
      bouton_rejoindre.classList.add('disabled');
      bouton_rejoindre.setAttribute('disabled', 'disabled');
    }
  }

  function structure_confirmation_submit() {
    let structure_confirmee = document.getElementById('compte_structure_confirmee').checked;
    activation_bouton_rejoindre(structure_confirmee);
    
    document.getElementById('compte_structure_confirmee').addEventListener('change', function() {
      activation_bouton_rejoindre(this.checked);
    });
  }

  document.addEventListener('DOMContentLoaded', structure_confirmation_submit);
</script>
<% end %>
